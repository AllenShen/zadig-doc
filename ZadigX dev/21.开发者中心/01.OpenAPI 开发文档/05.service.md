---
title: 服务
date: 2023-04-18 17:22:07
permalink: /ZadigX dev/api/service/
---

::: tip
本文所介绍的 OpenAPI 适用于 K8s YAML 服务。
:::

## 获取服务列表

**请求**

```
GET /openapi/service/yaml/services?projectName=<project_name>
```
**Query 参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `projectName` | string | 项目标识 | 是   |
**返回说明**

| 参数名        | 类型   | 描述     |
| ------------- | ------ | -------- |
| `services` | [][Service](#Service-1) | 测试服务列表 |
| `product_services` | [][Service](#Service-1) | 生产服务列表 |
<h4 id="Service-1">Service 参数说明</h4>

| 参数名         | 类型                        | 描述                                                         |
| -------------- | --------------------------- | ------------------------------------------------------------ |
| `service_name` | string                      | 服务名称                                                     |
| `type`         | string                      | 服务类型，固定值 `k8s`                           |
| `production`   | bool                        | 是否为生产服务                                               |
| `containers`   | [][Container](#Container-1) | 服务组件列表                                                 |

<h4 id="Container-1">Container 参数说明</h4>

| 参数名       | 类型   | 描述         |
| ------------ | ------ | ------------ |
| `name`       | string | 服务组件名称 |
| `image`      | string | 服务组件的镜像信息    |
| `image_name` | string | 服务组件的镜像名称  |

**返回示例**

::: details
```json
{
    "service": [
        {
            "service_name": "service-1",
            "source": "template",
            "type": "k8s",
            "production": false,
            "containers": [
                {
                    "name": "myapp-1",
                    "image": "koderover.******.com/koderover-demo/myapp-1:v0.1__linux_amd64",
                    "image_name": "myapp-1"
                }
            ]
        }
    ],
    "production_service": [
        {
            "service_name": "service-2",
            "source": "template",
            "type": "k8s",
            "production": true,
            "containers": [
                {
                    "name": "myapp-2",
                    "image": "koderover.******.com/koderover-demo/myapp-2:v0.1__linux_amd64",
                    "image_name": "myapp-2"
                }
            ]
        }
    ]
}
```
:::

## 获取服务详情

### 测试服务

**请求**

```
GET /openapi/service/yaml/:serviceName?projectName=<project_name>
```

**路径参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `serviceName` | string | 服务名称 | 是   |

**Query 参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `projectName` | string | 项目标识 | 是   |

**返回说明**

| 参数名                 | 类型                        | 描述                                |
| ---------------------- | --------------------------- | ----------------------------------- |
| `service_name`         | string                      | 服务名称                            |
| `created_by`           | string                      | 服务创建者                          |
| `created_time`         | int                         | 服务创建时间                        |
| `type`                 | string                      | 服务类型，固定为 `k8s` |
| `containers`           | [][Container](#Container-1) | 服务组件列表                        |
| `service_variable_kvs` | [][KeyVal](#KeyVal-4)       | 服务变量列表                        |
| `yaml`                 | string                      | 服务配置的 YAML 内容                 |

<h4 id="KeyVal-4">KeyVal 参数说明</h4>

| 参数名    | 说明                                                     | 类型     | 必填 |
| --------- | -------------------------------------------------------- | -------- | ---- |
| `key`     | 变量的键                                               | string   | 是   |
| `value`   | 变量的值，若有嵌套值，使用 json 格式                     | any      | 是   |
| `type`    | 变量值的类型，有四种类型：bool、string、enum、yaml   | string   | 是   |
| `options` | 变量可选值列表，当 `type` 为 `enum` 时该字段有意义 | []string | 否   |
| `desc`    | 变量描述信息                                          | String   | 否   |

#### 返回示例

:::details

```json
{
    "service_name": "service2",
    "type": "k8s",
    "created_by": "admin",
    "created_time": 1689660993,
    "yaml": "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service2\n  labels: \n    app.kubernetes.io/name: ai-test-2\n    app.kubernetes.io/instance: service2\n    hello: test\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: ai-test-2\n      app.kubernetes.io/instance: service2\n  replicas: 1\n  template:\n    metadata: \n      labels:\n        app.kubernetes.io/name: ai-test-2\n        app.kubernetes.io/instance: service2\n        hello: {{.world}}\n    spec:\n      containers:\n        - name: service2\n          image: koderover.******.com/koderover-demo/service2:latest\n          imagePullPolicy: Always \n          command:\n            - /workspace/service2\n          ports:\n            - protocol: TCP\n              containerPort: {{.port}}\n          resources:\n            limits:\n              memory: {{.memoryLimit}}\n              cpu: {{.cpuLimit}}\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service2\n  labels:\n    app.kubernetes.io/name: ai-test-2\n    app.kubernetes.io/instance: service2\nspec:\n  type: NodePort\n  ports:\n    - protocol: TCP\n      port: {{.port}}\n      targetPort: {{.port}}",
    "containers": [
        {
            "name": "service2",
            "image": "koderover.******.com/koderover-demo/service2:latest",
            "image_name": "service2"
        }
    ],
    "service_variable_kvs": [
        {
            "key": "cpuLimit",
            "value": "55m",
            "type": "string",
            "options": [],
            "desc": ""
        }
    ]
}
```

::: 

### 生产服务

**请求**

```
GET /openapi/service/yaml/production/:serviceName?projectName=<project_name>
```

**路径参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `serviceName` | string | 服务名称 | 是   |

**Query 参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `projectName` | string | 项目标识 | 是   |

**返回说明**

| 参数名                 | 类型                              | 描述                                |
| ---------------------- | --------------------------------- | ----------------------------------- |
| `service_name`         | string                            | 服务名称                            |
| `created_by`           | string                            | 服务创建者                          |
| `created_time`         | int                               | 服务创建时间                        |
| `type`                 | string                            | 服务类型，固定为 `k8s`            |
| `containers`           | [][Container](#Container-1)       | 服务组件列表                        |
| `service_variable_kvs` | [][KeyVal](#KeyVal-4)             | 服务变量列表                        |
| `yaml`                 | string                            | 服务配置的 YAML 内容                |

**返回示例**

:::details 

```json
{
    "service_name": "service2",
    "type": "k8s",
    "created_by": "admin",
    "created_time": 1689660993,
    "yaml": "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service2\n  labels: \n    app.kubernetes.io/name: ai-test-2\n    app.kubernetes.io/instance: service2\n    hello: test\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: ai-test-2\n      app.kubernetes.io/instance: service2\n  replicas: 1\n  template:\n    metadata: \n      labels:\n        app.kubernetes.io/name: ai-test-2\n        app.kubernetes.io/instance: service2\n        hello: {{.world}}\n    spec:\n      containers:\n        - name: service2\n          image: koderover.******.com/koderover-demo/service2:latest\n          imagePullPolicy: Always \n          command:\n            - /workspace/service2\n          ports:\n            - protocol: TCP\n              containerPort: {{.port}}\n          resources:\n            limits:\n              memory: {{.memoryLimit}}\n              cpu: {{.cpuLimit}}\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service2\n  labels:\n    app.kubernetes.io/name: ai-test-2\n    app.kubernetes.io/instance: service2\nspec:\n  type: NodePort\n  ports:\n    - protocol: TCP\n      port: {{.port}}\n      targetPort: {{.port}}",
    "containers": [
        {
            "name": "service2",
            "image": "koderover.******.com/koderover-demo/service2:latest",
            "image_name": "service2"
        }
    ],
    "service_variable_kvs": [
        {
            "key": "cpuLimit",
            "value": "55m",
            "type": "string",
            "options": [],
            "desc": ""
        }
    ]
}
```
::: 

## 获取服务的 YAML 内容

#### 请求

```
GET /openapi/service/yaml/<服务名称>?projectName=<项目标识>
```

#### 返回

返回服务具体的 YAML 内容，示例如下：

```json
{
    "yaml": "\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: db\n  name: db\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: db\n  template:\n    metadata:\n      labels:\n        app: db\n    spec:\n      containers:\n      - image: postgres:9.4\n        name: postgres\n        ports:\n        - containerPort: 5432\n          name: postgres\n        volumeMounts:\n        - mountPath: /var/lib/postgresql/data\n          name: db-data\n        env:\n        - name: POSTGRES_HOST_AUTH_METHOD\n          value: trust\n        resources:\n          limits:\n            memory: 50Mi\n            cpu: 50m\n      volumes:\n      - name: db-data\n        emptyDir: {}\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: db\n  name: db\nspec:\n  type: ClusterIP\n  ports:\n  - name: \"db-service\"\n    port: 5432\n    targetPort: 5432\n  selector:\n    app: db"
}
```

## 使用模板创建服务

### 测试服务

#### 请求

```
POST /openapi/service/template/load/yaml
```

#### Body 参数说明

|参数名|说明|类型|必填|
|----------------|-------------------|---|---|
|`service_name`  |服务名称|string|是|
|`project_key` |项目标识| string|是|
|`template_name`   | K8s Yaml 模板名称| string|是|
|`auto_sync` |自动同步开关| bool|否|
|`variable_yaml` |模板中的变量信息| [][KeyVal](#KeyVal)|否|

<h4 id="KeyVal">KeyVal 参数说明</h4>

|参数名|说明|类型|必填|
|---|---|---|---|
|`key`|变量的键值|string|是|
|`value`|变量的值，若有嵌套值，使用 json 格式|any|是|

#### Body 参数示例

使用模板 `microservice-template` 为项目 `demo` 创建服务 `service1`：

::: details
``` json
{
    "service_name": "service1",
    "project_key":"demo",
    "template_name": "microservice-template",
    "auto_sync": true,
    "variable_yaml": [
        {
            "key": "cpuLimit",
            "value": "100m"
        },
        {
            "key": "memoryLimit",
            "value": "100Mi"
        },
        {
            "key": "port",
            "value": "20221"
        }
    ]
}
```
:::

#### 返回

```json
{
  "message": "success"
}
```

### 生产服务

#### 请求

```
POST /openapi/service/template/production/load/yaml
```

**Body 参数说明**

| 参数名          | 说明              | 类型                  | 必填 |
| --------------- | ----------------- | --------------------- | ---- |
| `service_name`  | 服务名称          | string                | 是   |
| `yaml`          | 服务的 YAML 内容  | string                | 是   |
| `project_key`   | 项目标识          | string                | 是   |
| `template_name` | K8s Yaml 模板名称 | string                | 是   |
| `auto_sync`     | 自动同步开关      | bool                  | 否   |
| `variable_yaml` | 模板中的变量信息  | [][KeyVal](#KeyVal-1) | 否   |

<h4 id="KeyVal-1">KeyVal 参数说明</h4>

| 参数名  | 说明                                 | 类型   | 必填 |
| ------- | ------------------------------------ | ------ | ---- |
| `key`   | 变量的键值                           | string | 是   |
| `value` | 变量的值，若有嵌套值，使用 json 格式 | any    | 是   |

**Body 参数示例**

使用模板 base-template 为项目 `demo` 创建服务 `service1`：

::: details

```json
{
    "service_name": "service1",
    "production":true,
    "project_key":"demo",
    "template_name":"base-template",
    "auto_sync":true,
    "variable_yaml":[
        {
            "key":"cpuLimit",
            "value":"15m"
        }
    ]
}
```

:::

#### 返回

```json
{
  "message": "success"
}
```

## 手动输入创建服务

### 测试服务

#### 请求

```
POST /openapi/service/yaml/raw?projectName=<项目标识>
```

#### Body 参数说明

|参数名|说明|类型|必填|
|----------------|-------------------|---|---|
|`service_name` |服务名称|string|是|
|`yaml`   | 服务的 YAML 内容| string|是|

#### Body 参数示例

``` json
{
    "service_name": "service1",
    "yaml": "\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service1\n  labels: \n    app.kubernetes.io/name: demo\n    app.kubernetes.io/instance: service1\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: demo\n      app.kubernetes.io/instance: service1\n  replicas: 1\n  template:\n    metadata: \n      labels:\n        app.kubernetes.io/name: demo\n        app.kubernetes.io/instance: service1\n    spec:\n      containers:\n        - name: service1\n          image: koderover.******.com/koderover-demo/service1:latest\n          imagePullPolicy: Always \n          command:\n            - /workspace/service1\n          ports:\n            - protocol: TCP\n              containerPort: 20221\n          resources:\n            limits:\n              memory: 50Mi\n              cpu: 50m\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service1\n  labels:\n    app.kubernetes.io/name: demo\n    app.kubernetes.io/instance: service1\nspec:\n  type: NodePort\n  ports:\n    - protocol: TCP\n      port: 20221\n      targetPort: 20221"
}
```

#### 返回

```json
{
  "message": "success"
}
```

### 生产服务

#### 请求

```
POST /openapi/service/yaml/production/raw?projectName=<项目标识>
```

**Body 参数说明**

| 参数名          | 说明             | 类型        | 必填 |
| --------------- | ---------------- | ----------- | ---- |
| `service_name`  | 服务名称         | string      | 是   |
| `yaml`          | 服务的 YAML 内容 | string      | 是   |
| `variable_yaml` | yaml中的变量信息 | [][KeyVal](#KeyVal-4)  | 否   |

**Body 参数示例**

::: details 

```json
{
    "service_name":"service-3",
    "yaml":"apiVersion: v1\nkind: Service\nmetadata:\n  name: a\n  labels:\n    app: a\nspec:\n  ports:\n  - name: http\n    port: 80\n    targetPort: 8080\n  selector:\n    app: a\n\n---\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: a\n  labels:\n    app: a\nspec:\n  selector:\n    matchLabels:\n      app: a\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: a\n    spec:\n      containers:\n      - name: myapp-1\n        image: koderover.******.com/koderover-demo/myapp-1:v0.1__linux_amd64\n        imagePullPolicy: Always\n        command: [\"/myapp-1\"]\n        args: [\"--downstream-addr\", \"$(DOWNSTREAM_ADDR)\", \"--headers\", \"$(HEADERS)\"]\n        env:\n          - name: DOWNSTREAM_ADDR\n            value: \"b\"\n          - name: HEADERS\n            value: \"x-request-id\"\n        ports:\n        - containerPort: 8080\n        resources:\n          limits:\n            cpu: {{.cpu}}\n            memory: 122Mi\n",
    "variable_yaml":[
        {
            "key":"cpu",
            "value":"12m",
            "desc":"cpu值",
            "type":"string"
        }
    ]
}
```

::: 

**返回**

```json
{
  "message": "success"
}
```

## 更新服务配置

### 测试服务

#### 请求

```
PUT /openapi/service/yaml/:serviceName?projectName=<project_name>
```

#### 路径参数说明

|参数名|类型|描述|必填|
|---|---|---|--|
|`serviceName`|string|服务名称|是|

#### Query 参数说明

|参数名|类型|描述|必填|
|---|---|---|--|
|`projectName`|string|项目标识|是|

#### Body 参数说明
| 参数名 | 说明                | 类型   | 必填 |
| ------ | ------------------- | ------ | ---- |
| `type` | 服务类型，指定为 `k8s` | string | 是   |
| `yaml` | 服务配置的 YAML 内容    | string | 是   |

**Body 参数示例**

::: details 

```json
{
    "type":"k8s",
    "yaml":"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service1\n  labels: \n    app.kubernetes.io/name: demo\n    app.kubernetes.io/instance: service1\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: demo\n      app.kubernetes.io/instance: service1\n  replicas: 1\n  template:\n    metadata: \n      labels:\n        app.kubernetes.io/name: demo\n        app.kubernetes.io/instance: service1\n    spec:\n      containers:\n        - name: service1\n          image: koderover.******.com/koderover-demo/service1:latest\n          imagePullPolicy: Always \n          command:\n            - /workspace/service1\n          ports:\n            - protocol: TCP\n              containerPort: {{.port}}\n          resources:\n            limits:\n              memory: {{.memoryLimit}}\n              cpu: {{.cpuLimit}}\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service1\n  labels:\n    app.kubernetes.io/name: yaml-poc\n    app.kubernetes.io/instance: service1\nspec:\n  type: NodePort\n  ports:\n    - protocol: TCP\n      port: {{.port}}\n      targetPort: {{.port}}\n",
}
```

::: 

#### 返回

```json
{
  "message": "success"
}
```
### 生产服务

**请求**

```
PUT /openapi/service/yaml/production/:serviceName?projectName=<project_name>
```

**路径参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `serviceName` | string | 服务名称 | 是   |

**Query 参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `projectName` | string | 项目标识 | 是   |

**Body 参数说明**

| 参数名 | 说明                | 类型   | 必填 |
| ------ | ------------------- | ------ | ---- |
| `type` | 服务类型，指定为 `k8s` | string | 是   |
| `yaml` | 服务配置的 YAML 内容    | string | 是   |

**Body 参数示例**

::: details 

```json
{
    "type":"k8s",
    "yaml":"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service1\n  labels: \n    app.kubernetes.io/name: demo\n    app.kubernetes.io/instance: service1\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: demo\n      app.kubernetes.io/instance: service1\n  replicas: 1\n  template:\n    metadata: \n      labels:\n        app.kubernetes.io/name: demo\n        app.kubernetes.io/instance: service1\n    spec:\n      containers:\n        - name: service1\n          image: koderover.******.com/koderover-demo/service1:latest\n          imagePullPolicy: Always \n          command:\n            - /workspace/service1\n          ports:\n            - protocol: TCP\n              containerPort: {{.port}}\n          resources:\n            limits:\n              memory: {{.memoryLimit}}\n              cpu: {{.cpuLimit}}\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service1\n  labels:\n    app.kubernetes.io/name: yaml-poc\n    app.kubernetes.io/instance: service1\nspec:\n  type: NodePort\n  ports:\n    - protocol: TCP\n      port: {{.port}}\n      targetPort: {{.port}}\n",
}
```

::: 

**返回**

```json
{
  "message": "success"
}
```

## 更新服务变量

### 测试服务

**请求**

```
PUT /openapi/service/yaml/:serviceName/variable?projectName=<project_name>
```

**路径参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `serviceName` | string | 服务名称 | 是   |

**Query 参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `projectName` | string | 项目标识 | 是   |

**Body 参数说明**

| 参数名                 | 说明         | 类型        | 必填 |
| ---------------------- | ------------ | ----------- | ---- |
| `service_variable_kvs` | 服务变量列表 | [KeyVal](#KeyVal-4) | 是   |

**Body 参数示例**

::: details
```json
{
    "service_variable_kvs": [
        {
            "key": "cpuLimit",
            "value": "55m",
            "type": "string",
        }
    ]
}
```
:::

**返回**

```json
{
  "message": "success"
}
```

### 生产服务

**请求**

```
PUT /openapi/service/yaml/production/:serviceName/variable?projectName=<project_name>
```

**路径参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `serviceName` | string | 服务名称 | 是   |

**Query 参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `projectName` | string | 项目标识 | 是   |

**Body 参数说明**

| 参数名                 | 说明         | 类型        | 必填 |
| ---------------------- | ------------ | ----------- | ---- |
| `service_variable_kvs` | 服务变量列表 | [KeyVal](#KeyVal-4) | 是   |

**Body 参数示例**

::: details
```json
{
    "service_variable_kvs": [
        {
            "key": "level",
            "value": "2",
            "type": "enum",
            "options": ["1","2","3"],
        }
    ]
}
```
:::

**返回**

```json
{
  "message": "success"
}
```

## 删除服务

### 测试服务

#### 请求

```
DELETE /openapi/service/yaml/<服务名称>?projectName=<项目标识>
```

#### 返回

```json
{
  "message": "success"
}
```

### 生产服务

**请求**

```
DELETE /openapi/service/yaml/production/:serviceName?projectName=<项目标识>
```

**路径参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `serviceName` | string | 服务名称 | 是   |

**Query 参数说明**

| 参数名        | 类型   | 描述     | 必填 |
| ------------- | ------ | -------- | ---- |
| `projectName` | string | 项目标识 | 是   |

**返回**

```json
{
  "message": "success"
}
```
