---
title: 自定义工作流
date: 2022-07-08 11:02:00
permalink: /dev/project/common-workflow/
---

自定义工作流中提供了充分的开放性，支持自由编排工作流流程，自定义执行步骤，下面展开介绍相关概念和具体使用。

## 基本概念

- Workflow：工作流，可在工作流中编排多个 Stage 的执行过程
- Stage：对工作流执行阶段进行逻辑分组，比如构建 Stage、部署 Stage...多个 Stage 串行运行，一个 Stage 可包括多个 Job
- Job：一个完整的任务，比如构建、部署、测试...多个 Job 可串行执行或并发执行
<!-- - Step：组成 Job 的单元，比如克隆代码、执行 Shell 脚本、执行镜像构建、收集测试报告等... -->

## 新建

进入项目中点击新建工作流，选择`自定义工作流`，系统提供`界面化`和 `YAML` 两种方式来配置自定义工作流

![create_common_workflow](../_images/create_common_workflow_1.png)
![create_common_workflow](../_images/create_common_workflow_2.png)

## 界面化配置

### 基本信息

包括工作流名称和描述，同一项目下的工作流名称应唯一。

![common_workflow_config](../_images/common_workflow_config_0.png)

### Stage

点击 `+Stage` 增加新的 Stage 步骤。

![common_workflow_config](../_images/common_workflow_config_1.png)

参数说明：
- `Stage 名称`：在同一个自定义工作流中，Stage 名称唯一
- `并发执行`：开启后，在 Stage 下配置的多个 Job 将会并发执行
- `前置步骤`：可按需开启人工审核。开启后，需要审核通过，该 Stage 下的 Job 才会被执行

### Job
添加 Stage 后，点击 Stage 下方的 `+Job` 为 Stage 增加 Job 配置，系统目前支持`构建`和`部署`两种 Job 类型。

![common_workflow_config](../_images/common_workflow_config_2.png)

#### 构建 Job
![common_workflow_config](../_images/common_workflow_config_3.png)

参数说明：
- `Job 名称`：支持 32 位以内的小写英文字母、数字或者中划线，且以小写英文字母开头；在同一个自定义工作流中，Job 名称需唯一
- `镜像仓库`：选择镜像仓库，当构建 Job 执行完成功后，构建出的镜像（即内置 $IMAGE 变量）会被推送到所选仓库中
- `服务组件与构建配置`：选择服务组件与构建配置，支持设置构建配置中的自定义变量

::: tip
1. 内置构建 Job 执行结束后会输出 $IMAGE 变量（页面中不可见，系统隐式逻辑），可用于内置部署 Job 中。
2. 内置构建 Job 中不再支持 `$ENV_NAME` 构建变量，需要确保构建脚本中未使用该变量。
3. 暂不支持使用 Jenkins 构建。
:::

#### 部署 Job
![common_workflow_config](../_images/common_workflow_config_5.png)

参数说明：
- `Job 名称`：支持 32 位以内的小写英文字母、数字或者中划线，且以小写英文字母开头；在同一个自定义工作流中，Job 名称需唯一
- `环境`：选择要部署的环境
- `服务来源`：包括其他 Job 输出或运行时输入
    - `其他 Job 输出`：可选择前置 Job，使用 Job 中的 $IMAGE 变量来部署服务（目前只支持选择前置的构建 Job）
    - `运行时输入`：运行工作流时手动指定

### 人工审核
开启 Stage 配置中的`人工审核`，在 Stage 执行之前会触发审核。

![common_workflow_config](../_images/common_workflow_config_4.png)

参数说明：
- `超时时间`：从触发审核的时间点开始算起，当超过超时时间后视为审核超时失败，后续的 Stage 将不会执行
- `审核人`：选择希望参与审核的人员
- `需要审核人数`：当审核通过的人数满足此处指定的值时，即视为整个审核通过，Stage 会正常执行

## YAML 方式配置

### 配置说明

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`name`|string|工作流名称，全局唯一，匹配`^[a-z0-9-]{1,32}$`|untiled|是|
|`stages`|[][Stage](#stage_args)|Stage 列表，顺序执行|无|是|
|`project`|string|工作流所属项目名称|无|是|
|`description`|string|工作流描述信息|无|否|
|`multi_run`|bool|当同时触发多次工作流时，多条任务是否能并行执行|false|否|

<h4 id="stage_args">Stage 配置说明</h4>

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`name`|string|Stage 名称|无|是|
|`parallel`|bool|是否是否并发执行|false|否|
|`approval`|[Approval](#approval_args)|人工审核配置|无|否|
|`jobs`|[][Job](#job_args)|Job 列表|无|是|

<h4 id="approval_args">Approval 配置说明</h4>

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`enabled`|bool|是否开启人工审核|false|否|
|`approve_users`|[][ApproveUser](#approve_users_args)|审核人|无|当 enabled 为 true 时需配置|
|`timeout`|int|审核超时时间，单位为分钟|0|当 enabled 为 true 时需配置|
|`needed_approvers`|int|需要的审核人数|0|当 enabled 为 true 时需配置|
|`description`|string|关于审核的描述信息|无|否|

<h4 id="job_args">Job 配置说明</h4>

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`name`|string|Job 名称|无|是|
|`type`|string|Job 类型，目前支持 `zadig-build`(内置构建) 和 `zadig-deploy`(内置部署)|无|是|
|`spec`|[Spec](#spec-配置说明)|Job 的具体配置|无|是|

<h4 id="approve_users_args">ApproveUser 配置说明</h4>

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`user_id`|string|审核人 ID|无|开启审核后需配置|
|`user_name`|string|审核人昵称|无|开启审核后需配置|

<h4 id="spec_args">Spec 配置说明</h4>

1. 内置构建配置

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`docker_registry_id`|string|镜像仓库 ID|无|是|
|`service_and_builds`|[][ServiceAndBuild](#service_and_build_args)|服务、服务组件及构建配置|无|是|

<h5 id="service_and_build_args">ServiceAndBuild 配置说明</h5>

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`build_name`|string|构建配置的名称|无|是|
|`key_vals`|string|构建变量，若不配置则使用构建配置中的默认值|无|否|
|`service_module`|string|服务组件名称|无|是|
|`service_name`|string|服务名称|无|是|

<h5 id="key_vals_args">KeyVal 配置说明</h5>

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`is_credential`|bool|构建变量是否加密|false|否|
|`key`|string|构建变量的名称|无|否|
|`type`|string|构建变量的类型，支持 `string` 和 `choice` 两种|无|是|
|`choice_option`|[]string|构建变量的可选值|无|type 为 `choice` 时需配置|
|`value`|string|构建变量的值|无|是|

2. 内置部署配置

|参数名|类型|描述|默认值|是否必须|
|---|---|---|---|---|
|`env`|string|部署环境|无|是|
|`source`|string|指定服务来源，包括 `runtime`(运行时输入) 和 `fromjob`(其他 Job 输出)|无|是|
|`job_name`|string|指定 Job|无|当 source 为 `fromjob` 时需配置|

### YAML 样例

```
name: pre-release-deploy
stages:
  - name: 构建
    parallel: true
    jobs:
      - name: build-myapps
        type: zadig-build
        spec:
          docker_registry_id: 6247eb0832a15f910118318c
          service_and_builds:
            - build_name: simple-service-build-nginx-1
              key_vals:
                - is_credential: false
                  key: username
                  type: string
                  value: admin
                - is_credential: false
                  choice_option:
                    - v1
                    - v2
                  key: password
                  type: choice
                  value: v1
              service_module: myapp-1
              service_name: a
            - build_name: simple-service-build-myapp-2
              service_module: myapp-2
              service_name: b
  - name: 部署
    parallel: true
    approval:
      enabled: true
      approve_users:
        - user_id: af14dfd2-b57d-11ec-9511-9e1ccf83f7b3
          user_name: admin
        - user_id: 2d59d2f4-c6a5-11ec-a89e-2e173601a9ce
          user_name: zadig
      timeout: 120
      needed_approvers: 1
      description: '预发布环境部署，需审核通过方可执行'
    jobs:
      - name: deploy
        type: zadig-deploy
        spec:
          env: pre-release
          job_name: build-myapps
          source: fromjob
project: simple-service
description: 预发布环境部署
multi_run: false
```

## 执行
点击执行工作流，系统会默认按照工作流中的配置来运行。

![run_common_workflow](../_images/run_common_workflow_1.png)

点击具体 Job 可查看执行日志。
> Job 名称规则为：`服务名-服务组件名-Job 名`

![run_common_workflow](../_images/run_common_workflow_2.png)
