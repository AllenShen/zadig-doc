---
title: 发布中心
date: 2022-12-26 11:08:20
permalink: /v1.16.0/release/center
---
<Badge text="企业版" />

## 发布中心
发布中心集成了系统中所有的发布工作流，可全局预览所有发布工作流的所属项目、平均执行时间、成功率、最近成功及失败的时间，操作人。并提供执行、配置、删除工作流的快速入口。

![发布中心列表](./_images/release_list_01.png)

点击具体的工作流，将跳转至对应项目下的工作流，展示工作流详情。

![发布工作流](./_images/release_list_02.png)


## 发布模式介绍
Zadig 发布中心集成了所有发布工作流，目前支持蓝绿发布、金丝雀发布、分批次灰度发布、Istio 发布、更新 K8s YAML等任务，下面展开介绍相关概念，具体使用方法及操作流程可见[发布工作流](/v1.16.0/project/release-workflow/)。

## 蓝绿发布
### 概念介绍
蓝绿发布是一种以最小的停机时间做服务升级的策略。 需要维护的两个版本的环境分别称为 “蓝环境” 和 “绿环境”。一般当前生产流量指向环境为绿环境，而在蓝环境上部署新版本，短时间内作为测试环境。

**优点**
- 简单、快速、易于理解且易于实施
- 流量瞬时切换
- 相对于其他部署策略，风险较小。

**注意点**
- 双倍资源，可能产生更多成本。
- 服务从一个版本到另一个版本，当前的事务和会话将丢失。
- 数据库兼容性（架构更改、向后兼容性）。

### 工作原理
1. 部署蓝环境，复制当前 workload，设置新的镜像，创建一个 blue service 指向它。
2. 蓝环境部署完成，执行用户的验证任务。
3. 开始执行蓝绿发布，删除 blue service。
4. 将 green service 指向新创建的 workload。
5. 删除旧的 workload。
6. 发布过程完成或者中断删除蓝环境



## 金丝雀发布
### 概念介绍
在生产环境上引一部分实际流量对一个新版本进行测试，测试新版本的性能和表现，在保证系统整体稳定运行的前提下，尽早发现新版本在实际环境上的问题。

**优点**
- 相对于所有其他部署策略的风险最低（减少业务风险）。
- 使用真实用户和用例进行生产测试。
- 并排运行和比较两个服务版本。
- 比蓝绿发布节省资源，不需要有两个生产环境。

**注意点**
- 生产测试需要的监控和基础组件（APM、日志、基础设施、最终用户等）。
- 数据库兼容性（架构更改、向后兼容性）。

### 工作原理
1. 部署金丝雀，复制当前 workload，设置 replica，设置新的镜像，指向同一个 service 。
2. 部署金丝雀完成，执行用户验证任务。
3. 开始执行金丝雀发布，删除新创建的 workload。 
4. 滚动升级当前 workload 到新的镜像。
5. 发布过程完成或者中断均删除金丝雀


## 分批次灰度发布
灰度发布有很多种实现方式，除了金丝雀发布，Zadig 还支持分批次灰度发布，按照实际情况，分多次升级线上服务，比如第一次灰度 20%，将生产 20% 流量打入新版本，通过监控观测线上流量情况，第二次灰度 40% ，观测流量，没问题后全量上线。

### 工作原理
**首个灰度任务**
1. 初始化原始 deployment，系统自动加上灰度过程需要的 annotation。
    - &lt;origin-deployment-name&gt;-gray-release-image：记录发布前的镜像名称
    - &lt;origin-deployment-name&gt;-gray-release-container：记录发布前的容器名称
    - &lt;origin-deployment-name&gt;-gray-release-replica：记录发布前副本数量
2. 创建灰度的 deployment &lt;origin-deployment-name&gt;-zadig-gray，设置副本数量为向上取整（原始副本数*灰度百分比），设置镜像为新镜像，等待 deployment ready。
3. 调整原始 deployment 副本数量: 原始副本数量-新 deployment 副本数量，等待 deployment ready。

**中间状态灰度任务**
1. 设置新版本 deployment 副本数量为 向上取整（原始副本数*灰度百分比），等待 deployment ready。
2. 设置灰度 deployment 副本数量为原始副本数量-新 deployment 副本数量，等待 deployment ready。

**100% 灰度任务**
1. 设置原始 deployment：镜像设置为新版本，副本数量为原始副本数量，等待 deployment ready。
2. 删除灰度 deployment


## 灰度回滚
如果在灰度过程中出现不预期的中断或者需要回滚到灰度之前的状态，可以使用「灰度回滚」任务。

### 工作原理
1. 调整 deployment，对应容器的镜像为灰度之前的镜像，副本数量调整为上个版本的副本数，并等待 deployment ready。
2. 清理灰度 deployment。


## Istio 发布
Istio 发布是灰度发布的一种，使用 Istio 流量控制能力完成灰度过程。

### 工作原理

**首个 istio 发布任务**
- 创建名为 &lt;workload_name&gt;-zadig-copy 的 deployment
- 创建名为 &lt;workload_name&gt;-zadig 的 destination rule
- 如果提供了 virtual service， 则修改提供的 virtual service 中的 routing rules, 根据用户提供的比重设置 subset 权重
- 如果未提供 virtual service，则创建名为 &lt;workload_name&gt;-vs-zadig 的 virtual service

**中间状态 istio 发布任务**
- 修改上述规则中的 virtual service， 按照新的流量比重配置 subset 权重

**新版本流量 100% istio 发布任务**
- 修改目标 deployment 的镜像名称和副本数量，数值设置为新镜像和发布副本比例，并在 deployment 上打上对应的镜像名称和副本数量信息
- 根据是否提供 vs，回退 virtual service 成为最初版本/删除zadig创建的临时 virtual service
- 删除由 zadig 创建的临时 destination rule
- 删除由 zadig 创建的临时 deployment


## Istio 发布回滚

如果在 Istio 发布过程中出现不预期的中断或者需要回滚到发布之前的状态，可以使用「Istio 发布回滚」任务。

### 工作原理

- 清理名为 &lt;workload_name&gt;-zadig 的 destination rule
- 如果指定的 workload 中，存在上次应用的镜像名称和副本数量，则回退目标 workload 的镜像名称和副本数量到 annotation 中的版本。
- 无论如何，尝试删除名为 &lt;workload_name&gt;-zadig-copy 的 deployment

